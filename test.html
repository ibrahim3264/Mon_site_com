<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demande de Services - Shipping AIR</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf"></script>
</head>
<body>
  <!-- Bouton Accès Admin -->
  <div class="text-end p-3">
    <button class="btn btn-dark" onclick="demanderAccesAdmin()">Accès administrateur</button>
  </div>

  <!-- PAGE CLIENT -->
  <div class="container mt-3" id="client-page">
    <h2>Formulaire de Demande de Services pour Navire</h2>
    <form id="service-form">
      <div class="mb-3">
        <label for="nom" class="form-label">Nom du client</label>
        <input type="text" class="form-control" id="nom" required>
      </div>
      <div class="mb-3">
        <label for="email" class="form-label">Adresse e-mail</label>
        <input type="email" class="form-control" id="email" required>
      </div>
      <div class="mb-3">
        <label for="navire" class="form-label">Nom du navire</label>
        <input type="text" class="form-control" id="navire" required>
      </div>
      <div class="mb-3">
        <label for="service" class="form-label">Type de service</label>
        <select class="form-select" id="service" required>
          <option value="avitaillement">Avitaillement</option>
          <option value="enlevement">Enlèvement d'ordures</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="details" class="form-label">Détails du service</label>
        <textarea class="form-control" id="details" rows="3" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Envoyer la demande</button>
    </form>
    <div id="confirmation" class="alert alert-success mt-3 d-none">Demande envoyée avec succès !</div>
  </div>

  <!-- PAGE ADMINISTRATEUR (initialement cachée) -->
  <div class="container mt-5 d-none" id="admin-page">
    <h2>Tableau de Bord Administrateur</h2>
    <div id="commandes"></div>
  </div>

  <script>
    const form = document.getElementById("service-form");
    const confirmation = document.getElementById("confirmation");
    const commandes = [];

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        id: Date.now(),
        nom: document.getElementById("nom").value,
        email: document.getElementById("email").value,
        navire: document.getElementById("navire").value,
        service: document.getElementById("service").value,
        details: document.getElementById("details").value,
        status: "en attente"
      };

      commandes.push(data);
      confirmation.classList.remove("d-none");
      afficherCommandes();

      await fetch("https://jsonplaceholder.typicode.com/posts", {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-type": "application/json; charset=UTF-8" }
      });
    });

    function afficherCommandes() {
      document.getElementById("admin-page").classList.remove("d-none");
      let html = '<table class="table"><thead><tr><th>Commande</th><th>Client</th><th>Navire</th><th>Service</th><th>Action</th></tr></thead><tbody>';
      commandes.forEach((c) => {
        html += `<tr>
          <td>#${c.id}</td>
          <td>${c.nom} <br> ${c.email}</td>
          <td>${c.navire}</td>
          <td>${c.service}</td>
          <td>
            <button class="btn btn-success btn-sm" onclick="validerCommande(${c.id})">Valider</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="genererPDF(${c.id})">PDF</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById("commandes").innerHTML = html;
    }

    async function validerCommande(id) {
      const cmd = commandes.find(c => c.id === id);
      cmd.status = "validé";

      // EmailJS désactivé temporairement
      console.log(`Simulation d'envoi d'email à ${cmd.email} pour ${cmd.service}`);

      alert(`Commande #${cmd.id} validée (email non envoyé)`);
      afficherCommandes();
    }

    function genererPDF(id) {
      const cmd = commandes.find(c => c.id === id);
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text(`Reçu de Commande`, 20, 20);
      doc.text(`Commande #: ${cmd.id}`, 20, 30);
      doc.text(`Client: ${cmd.nom}`, 20, 40);
      doc.text(`Email: ${cmd.email}`, 20, 50);
      doc.text(`Navire: ${cmd.navire}`, 20, t60);
      doc.text(`Service: ${cmd.service}`, 20, 70);
      doc.text(`Détails: ${cmd.details}`, 20, 80);
      doc.text(`Statut: ${cmd.status}`, 20, 90);
      doc.save(`recu_commande_${cmd.id}.pdf`);
    }

    function demanderAccesAdmin() {
      console.log("Bouton admin cliqué");
      const mdp = prompt("Mot de passe admin ?");
      if (mdp === "admin123") {
        console.log("Mot de passe correct, affichage admin-page");
        const adminPage = document.getElementById("admin-page");
        adminPage.classList.remove("d-none");
        adminPage.style.display = "block";
      } else {
        alert("Mot de passe incorrect");
      }
    }
  </script>
</body>
</html>
